{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="text-center mb-5">
            <h1 class="display-4 text-primary">
                <i class="fas fa-school"></i> 
                Sistem Kontrol Guru
            </h1>
            <p class="lead">MAN Insan Cendekia Kota Kendari</p>
            <p class="text-muted">Sistem manajemen kehadiran, jurnal pembelajaran, dan tugas guru</p>
        </div>

        <div class="row">
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-qrcode fa-3x text-primary mb-3"></i>
                        <h5 class="card-title">Scan Barcode</h5>
                        <p class="card-text">Guru dapat melakukan absensi masuk dan keluar dengan scan barcode menggunakan HP</p>
                        <a href="#" class="btn btn-primary" onclick="startScanner()">
                            <i class="fas fa-camera"></i> Mulai Scan
                        </a>
                    </div>
                </div>
            </div>

            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-sign-in-alt fa-3x text-success mb-3"></i>
                        <h5 class="card-title">Login Sistem</h5>
                        <p class="card-text">Akses dashboard untuk guru dan tim akademik</p>
                        <a href="{{ url_for('login') }}" class="btn btn-success">
                            <i class="fas fa-user"></i> Login
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-info-circle"></i> Fitur Sistem</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <h6><i class="fas fa-clock text-primary"></i> Kontrol Kehadiran</h6>
                                <p class="small text-muted">Monitoring real-time kehadiran guru dengan scan barcode</p>
                            </div>
                            <div class="col-md-4 mb-3">
                                <h6><i class="fas fa-book text-success"></i> Jurnal Pembelajaran</h6>
                                <p class="small text-muted">Pencatatan materi dan aktivitas pembelajaran harian</p>
                            </div>
                            <div class="col-md-4 mb-3">
                                <h6><i class="fas fa-tasks text-warning"></i> Manajemen Tugas</h6>
                                <p class="small text-muted">Kontrol tugas yang diberikan kepada siswa</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Scanner -->
<div class="modal fade" id="scannerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Scan Barcode Absensi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div id="scanner-container">
                    <video id="scanner-video" width="100%" height="300" style="border: 2px solid #007bff;"></video>
                </div>
                <div id="scanner-result" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script>
let video, canvas, context;
let scanning = false;

function startScanner() {
    const modal = new bootstrap.Modal(document.getElementById('scannerModal'));
    modal.show();
    
    video = document.getElementById('scanner-video');
    canvas = document.createElement('canvas');
    context = canvas.getContext('2d');
    
    navigator.mediaDevices.getUserMedia({ 
        video: { facingMode: 'environment' } 
    }).then(stream => {
        video.srcObject = stream;
        video.play();
        scanning = true;
        scanQRCode();
    }).catch(err => {
        document.getElementById('scanner-result').innerHTML = 
            '<div class="alert alert-danger">Error: Tidak dapat mengakses kamera</div>';
    });
}

function scanQRCode() {
    if (!scanning) return;
    
    if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvas.height = video.videoHeight;
        canvas.width = video.videoWidth;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height);
        
        if (code) {
            scanning = false;
            video.srcObject.getTracks().forEach(track => track.stop());
            
            // Kirim data ke server
            fetch('/api/scan', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ qr_data: code.data })
            })
            .then(response => response.json())
            .then(data => {
                const alertClass = data.success ? 'alert-success' : 'alert-danger';
                document.getElementById('scanner-result').innerHTML = 
                    `<div class="alert ${alertClass}">${data.message}</div>`;
            })
            .catch(error => {
                document.getElementById('scanner-result').innerHTML = 
                    '<div class="alert alert-danger">Error: Gagal mengirim data</div>';
            });
        }
    }
    
    if (scanning) {
        requestAnimationFrame(scanQRCode);
    }
}

// Stop scanner when modal is closed
document.getElementById('scannerModal').addEventListener('hidden.bs.modal', function () {
    scanning = false;
    if (video && video.srcObject) {
        video.srcObject.getTracks().forEach(track => track.stop());
    }
});
</script>
{% endblock %}