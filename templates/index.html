{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="text-center mb-5">
            <h1 class="display-4 text-primary">
                <i class="fas fa-school"></i> 
                Sistem Kontrol Guru
            </h1>
            <p class="lead">MAN Insan Cendekia Kota Kendari</p>
            <p class="text-muted">Sistem manajemen kehadiran, jurnal pembelajaran, dan tugas guru</p>
        </div>

        <div class="row">
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-qrcode fa-3x text-primary mb-3"></i>
                        <h5 class="card-title">Scan Barcode</h5>
                        <p class="card-text">Guru dapat melakukan absensi masuk dan keluar dengan scan barcode menggunakan HP</p>
                        <a href="#" class="btn btn-primary" onclick="startScanner()">
                            <i class="fas fa-camera"></i> Mulai Scan
                        </a>
                    </div>
                </div>
            </div>

            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-sign-in-alt fa-3x text-success mb-3"></i>
                        <h5 class="card-title">Login Sistem</h5>
                        <p class="card-text">Akses dashboard untuk guru dan tim akademik</p>
                        <a href="{{ url_for('login') }}" class="btn btn-success">
                            <i class="fas fa-user"></i> Login
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-info-circle"></i> Fitur Sistem</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <h6><i class="fas fa-clock text-primary"></i> Kontrol Kehadiran</h6>
                                <p class="small text-muted">Monitoring real-time kehadiran guru dengan scan barcode</p>
                            </div>
                            <div class="col-md-4 mb-3">
                                <h6><i class="fas fa-book text-success"></i> Jurnal Pembelajaran</h6>
                                <p class="small text-muted">Pencatatan materi dan aktivitas pembelajaran harian</p>
                            </div>
                            <div class="col-md-4 mb-3">
                                <h6><i class="fas fa-tasks text-warning"></i> Manajemen Tugas</h6>
                                <p class="small text-muted">Kontrol tugas yang diberikan kepada siswa</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Scanner -->
<div class="modal fade" id="scannerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Scan Barcode Absensi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Form Input Kelas dan Mata Pelajaran -->
                <div id="absensi-form" class="mb-3">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Pilih kelas dan mata pelajaran sebelum scan QR code
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Kelas</label>
                            <select class="form-select" id="kelas-absensi" required>
                                <option value="">Pilih Kelas</option>
                                <option value="X-1">X-1</option>
                                <option value="X-2">X-2</option>
                                <option value="X-3">X-3</option>
                                <option value="X-4">X-4</option>
                                <option value="X-5">X-5</option>
                                <option value="XI-1">XI-1</option>
                                <option value="XI-2">XI-2</option>
                                <option value="XI-3">XI-3</option>
                                <option value="XI-4">XI-4</option>
                                <option value="XI-5">XI-5</option>
                                <option value="XII-1">XII-1</option>
                                <option value="XII-2">XII-2</option>
                                <option value="XII-3">XII-3</option>
                                <option value="XII-4">XII-4</option>
                                <option value="XII-5">XII-5</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Mata Pelajaran</label>
                            <select class="form-select" id="mapel-absensi" required>
                                <option value="">Pilih Mata Pelajaran</option>
                                <option value="Matematika">Matematika</option>
                                <option value="Fisika">Fisika</option>
                                <option value="Kimia">Kimia</option>
                                <option value="Biologi">Biologi</option>
                                <option value="Bahasa Indonesia">Bahasa Indonesia</option>
                                <option value="Bahasa Inggris">Bahasa Inggris</option>
                                <option value="Sejarah">Sejarah</option>
                                <option value="Geografi">Geografi</option>
                                <option value="Ekonomi">Ekonomi</option>
                                <option value="Sosiologi">Sosiologi</option>
                                <option value="Akidah Akhlak">Akidah Akhlak</option>
                                <option value="Alquran Hadits">Alquran Hadits</option>
                                <option value="Fiqih">Fiqih</option>
                                <option value="Bahasa Arab">Bahasa Arab</option>
                                <option value="Sejarah Kebudayaan Islam">Sejarah Kebudayaan Islam</option>
                                <option value="Matematika Lanjut">Matematika Lanjut</option>
                                <option value="PJOK">PJOK</option>
                                <option value="Prakarya">Prakarya</option>
                                <option value="Seni Budaya">Seni Budaya</option>
                                <option value="Bimbingan Konseling">Bimbingan Konseling</option>
                                <option value="PKn">Pendidikan Kewarganegaraan</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Scanner Container -->
                <div class="text-center">
                    <div id="scanner-container">
                        <video id="scanner-video" width="100%" height="300" style="border: 2px solid #007bff;"></video>
                    </div>
                    <div id="scanner-result" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script>
let video, canvas, context;
let scanning = false;

function startScanner() {
    const modal = new bootstrap.Modal(document.getElementById('scannerModal'));
    modal.show();
    
    video = document.getElementById('scanner-video');
    canvas = document.createElement('canvas');
    context = canvas.getContext('2d');
    
    navigator.mediaDevices.getUserMedia({ 
        video: { facingMode: 'environment' } 
    }).then(stream => {
        video.srcObject = stream;
        video.play();
        scanning = true;
        scanQRCode();
    }).catch(err => {
        document.getElementById('scanner-result').innerHTML = 
            '<div class="alert alert-danger">Error: Tidak dapat mengakses kamera</div>';
    });
}

function scanQRCode() {
    if (!scanning) return;
    
    if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvas.height = video.videoHeight;
        canvas.width = video.videoWidth;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height);
        
        if (code) {
            scanning = false;
            video.srcObject.getTracks().forEach(track => track.stop());
            
            // Validasi input kelas dan mata pelajaran
            const kelas = document.getElementById('kelas-absensi').value;
            const mataPelajaran = document.getElementById('mapel-absensi').value;
            
            if (!kelas || !mataPelajaran) {
                document.getElementById('scanner-result').innerHTML = 
                    '<div class="alert alert-warning">Pilih kelas dan mata pelajaran terlebih dahulu!</div>';
                // Restart scanner
                setTimeout(() => {
                    scanning = true;
                    video.srcObject.getTracks().forEach(track => track.stop());
                    startScanner();
                }, 2000);
                return;
            }
            
            // Kirim data ke server dengan kelas dan mata pelajaran
            fetch('/api/scan', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    qr_data: code.data,
                    kelas: kelas,
                    mata_pelajaran: mataPelajaran
                })
            })
            .then(response => response.json())
            .then(data => {
                const alertClass = data.success ? 'alert-success' : 'alert-danger';
                document.getElementById('scanner-result').innerHTML = 
                    `<div class="alert ${alertClass}">
                        <strong>${data.message}</strong><br>
                        <small>Kelas: ${kelas} | Mata Pelajaran: ${mataPelajaran}</small>
                    </div>`;
                
                // Reset form jika sukses
                if (data.success) {
                    document.getElementById('kelas-absensi').value = '';
                    document.getElementById('mapel-absensi').value = '';
                }
            })
            .catch(error => {
                document.getElementById('scanner-result').innerHTML = 
                    '<div class="alert alert-danger">Error: Gagal mengirim data</div>';
            });
        }
    }
    
    if (scanning) {
        requestAnimationFrame(scanQRCode);
    }
}

// Stop scanner when modal is closed
document.getElementById('scannerModal').addEventListener('hidden.bs.modal', function () {
    scanning = false;
    if (video && video.srcObject) {
        video.srcObject.getTracks().forEach(track => track.stop());
    }
    // Reset form
    document.getElementById('kelas-absensi').value = '';
    document.getElementById('mapel-absensi').value = '';
    document.getElementById('scanner-result').innerHTML = '';
});
</script>
{% endblock %}
