{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-chart-line"></i> Dashboard Tim Akademik</h2>
        <p class="text-muted">Monitoring dan kontrol aktivitas guru</p>
    </div>
</div>

<!-- Statistik Utama -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <i class="fas fa-users fa-2x mb-2"></i>
                <h3>{{ total_guru }}</h3>
                <p class="mb-0">Total Guru</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <i class="fas fa-check-circle fa-2x mb-2"></i>
                <h3>{{ kehadiran_hari_ini }}</h3>
                <p class="mb-0">Hadir Hari Ini</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <i class="fas fa-chalkboard-teacher fa-2x mb-2"></i>
                <h3>{{ guru_mengajar }}</h3>
                <p class="mb-0">Sedang Mengajar</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card bg-warning text-white">
            <div class="card-body text-center">
                <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                <h3>{{ total_guru - kehadiran_hari_ini }}</h3>
                <p class="mb-0">Belum Hadir</p>
            </div>
        </div>
    </div>
</div>

<!-- Menu Utama -->
<div class="row">
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5><i class="fas fa-clock"></i> Monitoring Kehadiran</h5>
            </div>
            <div class="card-body">
                <p>Pantau kehadiran guru secara real-time</p>
                <a href="#" class="btn btn-primary" onclick="loadKehadiran()">
                    <i class="fas fa-eye"></i> Lihat Kehadiran Hari Ini
                </a>
                <a href="#" class="btn btn-outline-primary">
                    <i class="fas fa-calendar"></i> Laporan Bulanan
                </a>
            </div>
        </div>
    </div>

    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5><i class="fas fa-user-plus"></i> Manajemen Guru</h5>
            </div>
            <div class="card-body">
                <p>Kelola data guru dan jadwal mengajar</p>
                <a href="#" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#guruModal">
                    <i class="fas fa-plus"></i> Tambah Guru
                </a>
                <a href="#" class="btn btn-outline-success" onclick="loadDaftarGuru()">
                    <i class="fas fa-list"></i> Daftar Guru
                </a>
            </div>
        </div>
    </div>

    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5><i class="fas fa-book"></i> Jurnal Pembelajaran</h5>
            </div>
            <div class="card-body">
                <p>Monitor jurnal pembelajaran guru</p>
                <a href="#" class="btn btn-info" onclick="loadJurnal()">
                    <i class="fas fa-eye"></i> Lihat Jurnal Hari Ini
                </a>
                <a href="#" class="btn btn-outline-info">
                    <i class="fas fa-chart-bar"></i> Statistik Jurnal
                </a>
            </div>
        </div>
    </div>

    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header bg-warning text-white">
                <h5><i class="fas fa-tasks"></i> Monitoring Tugas</h5>
            </div>
            <div class="card-body">
                <p>Pantau tugas yang diberikan guru</p>
                <a href="#" class="btn btn-warning" onclick="loadTugas()">
                    <i class="fas fa-eye"></i> Lihat Tugas Aktif
                </a>
                <a href="#" class="btn btn-outline-warning">
                    <i class="fas fa-chart-pie"></i> Laporan Tugas
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Area Konten Dinamis -->
<div class="row">
    <div class="col-12">
        <div id="dynamic-content"></div>
    </div>
</div>

<!-- Modal Tambah Guru -->
<div class="modal fade" id="guruModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Tambah Guru Baru</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="guruForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">NIP</label>
                            <input type="text" class="form-control" name="nip" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nama Lengkap</label>
                            <input type="text" class="form-control" name="nama" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Mata Pelajaran</label>
                            <select class="form-select" name="mata_pelajaran" required>
                                <option value="">Pilih Mata Pelajaran</option>
                                <option value="Matematika">Matematika</option>
                                <option value="Fisika">Fisika</option>
                                <option value="Kimia">Kimia</option>
                                <option value="Biologi">Biologi</option>
                                <option value="Bahasa Indonesia">Bahasa Indonesia</option>
                                <option value="Bahasa Inggris">Bahasa Inggris</option>
                                <option value="Sejarah">Sejarah</option>
                                <option value="Geografi">Geografi</option>
                                <option value="Ekonomi">Ekonomi</option>
                                <option value="Sosiologi">Sosiologi</option>
                                <option value="Akidah Akhlak">Akidah Akhlak</option>
                                <option value="Alquran Hadits">Alquran Hadits</option>
                                <option value="Fiqih">Fiqih</option>
                                <option value="Bahasa Arab">Bahasa Arab</option>
                                <option value="Sejarah Kebudayaan Islam">Sejarah Kebudayaan Islam</option>
                                <option value="Matematika Lanjut">Matematika Lanjut</option>
                                <option value="PJOK">PJOK</option>
                                <option value="Prakarya">Prakarya</option>
                                <option value="Seni Budaya">Seni Budaya</option>
                                <option value="Bimbingan Konseling">Bimbingan Konseling</option>
                                <option value="PKn">Pendidikan Kewarganegaraan</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="email" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-control" name="password" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-success">Simpan Guru</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function loadKehadiran() {
    document.getElementById('dynamic-content').innerHTML = `
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-clock"></i> Kehadiran Guru Hari Ini</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Nama Guru</th>
                                <th>NIP</th>
                                <th>Mata Pelajaran</th>
                                <th>Jam Masuk</th>
                                <th>Jam Keluar</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="6" class="text-center">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
    
    // Fetch data kehadiran via AJAX
    fetch('/api/kehadiran-hari-ini')
        .then(response => response.json())
        .then(data => {
            // Update table with real data
            console.log('Data kehadiran:', data);
        });
}

function loadDaftarGuru() {
    document.getElementById('dynamic-content').innerHTML = `
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-users"></i> Daftar Guru</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="guruTable">
                        <thead>
                            <tr>
                                <th>Nama</th>
                                <th>NIP</th>
                                <th>Mata Pelajaran</th>
                                <th>Email</th>
                                <th>QR Code</th>
                                <th>Tanggal Dibuat</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="6" class="text-center">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
    
    // Fetch data guru
    fetch('/api/daftar-guru')
        .then(response => response.json())
        .then(data => {
            const tbody = document.querySelector('#guruTable tbody');
            if (data.success && data.data.length > 0) {
                tbody.innerHTML = '';
                data.data.forEach(guru => {
                    const qrCodeImg = guru.qr_code ? 
                        `<img src="data:image/png;base64,${guru.qr_code}" width="50" height="50" alt="QR Code">` : 
                        '<span class="text-muted">Belum ada</span>';
                    
                    tbody.innerHTML += `
                        <tr>
                            <td>${guru.nama}</td>
                            <td>${guru.nip}</td>
                            <td>${guru.mata_pelajaran}</td>
                            <td>${guru.email}</td>
                            <td>${qrCodeImg}</td>
                            <td>${guru.created_at}</td>
                        </tr>
                    `;
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Belum ada data guru</td></tr>';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.querySelector('#guruTable tbody').innerHTML = 
                '<tr><td colspan="6" class="text-center text-danger">Error loading data</td></tr>';
        });
}

function loadJurnal() {
    document.getElementById('dynamic-content').innerHTML = `
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-book"></i> Jurnal Pembelajaran Hari Ini</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="jurnalTable">
                        <thead>
                            <tr>
                                <th>Waktu</th>
                                <th>Guru</th>
                                <th>Kelas</th>
                                <th>Mata Pelajaran</th>
                                <th>Materi</th>
                                <th>Metode</th>
                                <th>Kehadiran</th>
                                <th>Catatan</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="8" class="text-center">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
    
    // Fetch data jurnal
    fetch('/api/monitoring-jurnal')
        .then(response => response.json())
        .then(data => {
            const tbody = document.querySelector('#jurnalTable tbody');
            if (data.success && data.data.length > 0) {
                tbody.innerHTML = '';
                data.data.forEach(jurnal => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${jurnal.waktu_input}</td>
                            <td>
                                <strong>${jurnal.guru_nama}</strong><br>
                                <small class="text-muted">${jurnal.guru_nip}</small>
                            </td>
                            <td>${jurnal.kelas}</td>
                            <td>${jurnal.mata_pelajaran}</td>
                            <td>${jurnal.materi}</td>
                            <td>${jurnal.metode_pembelajaran || '-'}</td>
                            <td>
                                <span class="badge bg-success">${jurnal.siswa_hadir} Hadir</span>
                                ${jurnal.siswa_tidak_hadir > 0 ? `<span class="badge bg-warning">${jurnal.siswa_tidak_hadir} Tidak Hadir</span>` : ''}
                            </td>
                            <td>${jurnal.catatan || '-'}</td>
                        </tr>
                    `;
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Belum ada jurnal hari ini</td></tr>';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.querySelector('#jurnalTable tbody').innerHTML = 
                '<tr><td colspan="8" class="text-center text-danger">Error loading data</td></tr>';
        });
}

function loadTugas() {
    document.getElementById('dynamic-content').innerHTML = `
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-tasks"></i> Monitoring Tugas Aktif</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="tugasTable">
                        <thead>
                            <tr>
                                <th>Guru</th>
                                <th>Judul Tugas</th>
                                <th>Kelas</th>
                                <th>Mata Pelajaran</th>
                                <th>Diberikan</th>
                                <th>Deadline</th>
                                <th>Status</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="8" class="text-center">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
    
    // Fetch data tugas
    fetch('/api/monitoring-tugas')
        .then(response => response.json())
        .then(data => {
            const tbody = document.querySelector('#tugasTable tbody');
            if (data.success && data.data.length > 0) {
                tbody.innerHTML = '';
                data.data.forEach(tugas => {
                    let statusBadge = '';
                    if (tugas.status_deadline === 'overdue') {
                        statusBadge = `<span class="badge bg-danger">Terlambat ${Math.abs(tugas.sisa_hari)} hari</span>`;
                    } else if (tugas.status_deadline === 'urgent') {
                        statusBadge = `<span class="badge bg-warning">${tugas.sisa_hari} hari lagi</span>`;
                    } else {
                        statusBadge = `<span class="badge bg-success">${tugas.sisa_hari} hari lagi</span>`;
                    }
                    
                    tbody.innerHTML += `
                        <tr>
                            <td>
                                <strong>${tugas.guru_nama}</strong><br>
                                <small class="text-muted">${tugas.guru_nip}</small>
                            </td>
                            <td>
                                <strong>${tugas.judul}</strong><br>
                                <small class="text-muted">${tugas.deskripsi.substring(0, 50)}...</small>
                            </td>
                            <td>${tugas.kelas}</td>
                            <td>${tugas.mata_pelajaran}</td>
                            <td>${tugas.tanggal_diberikan}</td>
                            <td>${tugas.deadline}</td>
                            <td>${statusBadge}</td>
                            <td>
                                <button class="btn btn-sm btn-info" onclick="viewTugas(${tugas.id})">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Belum ada tugas aktif</td></tr>';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.querySelector('#tugasTable tbody').innerHTML = 
                '<tr><td colspan="8" class="text-center text-danger">Error loading data</td></tr>';
        });
}

function viewTugas(tugasId) {
    // Implementasi view detail tugas
    alert('Fitur view detail tugas akan segera tersedia');
}

// Handle form submission
document.getElementById('guruForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = Object.fromEntries(formData);
    
    fetch('/api/tambah-guru', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Guru berhasil ditambahkan!');
            bootstrap.Modal.getInstance(document.getElementById('guruModal')).hide();
            this.reset();
            // Refresh daftar guru jika sedang ditampilkan
            if (document.getElementById('guruTable')) {
                loadDaftarGuru();
            }
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        alert('Terjadi kesalahan: ' + error);
    });
});
</script>
{% endblock %}
