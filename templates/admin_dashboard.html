{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-chart-line"></i> Dashboard Tim Akademik</h2>
        <p class="text-muted">Monitoring dan kontrol aktivitas guru</p>
    </div>
</div>

<!-- Statistik Utama -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <i class="fas fa-users fa-2x mb-2"></i>
                <h3>{{ total_guru }}</h3>
                <p class="mb-0">Total Guru</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <i class="fas fa-check-circle fa-2x mb-2"></i>
                <h3>{{ kehadiran_hari_ini }}</h3>
                <p class="mb-0">Hadir Hari Ini</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <i class="fas fa-chalkboard-teacher fa-2x mb-2"></i>
                <h3>{{ guru_mengajar }}</h3>
                <p class="mb-0">Sedang Mengajar</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card bg-warning text-white">
            <div class="card-body text-center">
                <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                <h3>{{ total_guru - kehadiran_hari_ini }}</h3>
                <p class="mb-0">Belum Hadir</p>
            </div>
        </div>
    </div>
</div>

<!-- Menu Utama -->
<div class="row">
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5><i class="fas fa-clock"></i> Monitoring Kehadiran</h5>
            </div>
            <div class="card-body">
                <p>Pantau kehadiran guru secara real-time</p>
                <a href="#" class="btn btn-primary" onclick="loadKehadiran()">
                    <i class="fas fa-eye"></i> Lihat Kehadiran Hari Ini
                </a>
                <a href="#" class="btn btn-outline-primary">
                    <i class="fas fa-calendar"></i> Laporan Bulanan
                </a>
            </div>
        </div>
    </div>

    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5><i class="fas fa-user-plus"></i> Manajemen Guru</h5>
            </div>
            <div class="card-body">
                <p>Kelola data guru dan jadwal mengajar</p>
                <a href="#" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#guruModal">
                    <i class="fas fa-plus"></i> Tambah Guru
                </a>
                <a href="#" class="btn btn-outline-success" onclick="loadDaftarGuru()">
                    <i class="fas fa-list"></i> Daftar Guru
                </a>
            </div>
        </div>
    </div>

    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5><i class="fas fa-book"></i> Jurnal Pembelajaran</h5>
            </div>
            <div class="card-body">
                <p>Monitor jurnal pembelajaran guru</p>
                <a href="#" class="btn btn-info" onclick="loadJurnal()">
                    <i class="fas fa-eye"></i> Lihat Jurnal Hari Ini
                </a>
                <a href="#" class="btn btn-outline-info">
                    <i class="fas fa-chart-bar"></i> Statistik Jurnal
                </a>
            </div>
        </div>
    </div>

    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header bg-warning text-white">
                <h5><i class="fas fa-tasks"></i> Monitoring Tugas</h5>
            </div>
            <div class="card-body">
                <p>Pantau tugas yang diberikan guru</p>
                <a href="#" class="btn btn-warning" onclick="loadTugas()">
                    <i class="fas fa-eye"></i> Lihat Tugas Aktif
                </a>
                <a href="#" class="btn btn-outline-warning">
                    <i class="fas fa-chart-pie"></i> Laporan Tugas
                </a>
            </div>
        </div>
    </div>

    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h5><i class="fas fa-calendar-alt"></i> Jadwal Mengajar</h5>
            </div>
            <div class="card-body">
                <p>Kelola jadwal mengajar guru</p>
                <a href="#" class="btn btn-secondary" onclick="loadJadwal()">
                    <i class="fas fa-eye"></i> Lihat Jadwal
                </a>
                <a href="#" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#jadwalModal">
                    <i class="fas fa-plus"></i> Tambah Jadwal
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Area Konten Dinamis -->
<div class="row">
    <div class="col-12">
        <div id="dynamic-content"></div>
    </div>
</div>

<!-- Modal Tambah Guru -->
<div class="modal fade" id="guruModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Tambah Guru Baru</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="guruForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">NIP</label>
                            <input type="text" class="form-control" name="nip" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nama Lengkap</label>
                            <input type="text" class="form-control" name="nama" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Mata Pelajaran</label>
                            <select class="form-select" name="mata_pelajaran" required>
                                <option value="">Pilih Mata Pelajaran</option>
                                <option value="Matematika">Matematika</option>
                                <option value="Fisika">Fisika</option>
                                <option value="Kimia">Kimia</option>
                                <option value="Biologi">Biologi</option>
                                <option value="Bahasa Indonesia">Bahasa Indonesia</option>
                                <option value="Bahasa Inggris">Bahasa Inggris</option>
                                <option value="Sejarah">Sejarah</option>
                                <option value="Geografi">Geografi</option>
                                <option value="Ekonomi">Ekonomi</option>
                                <option value="Sosiologi">Sosiologi</option>
                                <option value="Akidah Akhlak">Akidah Akhlak</option>
                                <option value="Alquran Hadits">Alquran Hadits</option>
                                <option value="Fiqih">Fiqih</option>
                                <option value="Bahasa Arab">Bahasa Arab</option>
                                <option value="Sejarah Kebudayaan Islam">Sejarah Kebudayaan Islam</option>
                                <option value="Matematika Lanjut">Matematika Lanjut</option>
                                <option value="PJOK">PJOK</option>
                                <option value="Prakarya">Prakarya</option>
                                <option value="Seni Budaya">Seni Budaya</option>
                                <option value="Bimbingan Konseling">Bimbingan Konseling</option>
                                <option value="PKn">Pendidikan Kewarganegaraan</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="email" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-control" name="password" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-success">Simpan Guru</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Tambah Jadwal -->
<div class="modal fade" id="jadwalModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Tambah Jadwal Mengajar</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="jadwalForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Guru</label>
                            <select class="form-select" name="guru_id" id="guruSelect" required>
                                <option value="">Pilih Guru</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Hari</label>
                            <select class="form-select" name="hari" required>
                                <option value="">Pilih Hari</option>
                                <option value="Senin">Senin</option>
                                <option value="Selasa">Selasa</option>
                                <option value="Rabu">Rabu</option>
                                <option value="Kamis">Kamis</option>
                                <option value="Jumat">Jumat</option>
                                <option value="Sabtu">Sabtu</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Jam Mulai</label>
                            <input type="time" class="form-control" name="jam_mulai" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Jam Selesai</label>
                            <input type="time" class="form-control" name="jam_selesai" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Kelas</label>
                            <select class="form-select" name="kelas" required>
                                <option value="">Pilih Kelas</option>
                                <option value="X-1">X-1</option>
                                <option value="X-2">X-2</option>
                                <option value="X-3">X-3</option>
                                <option value="X-4">X-4</option>
                                <option value="X-5">X-5</option>
                                <option value="XI-1">XI-1</option>
                                <option value="XI-2">XI-2</option>
                                <option value="XI-3">XI-3</option>
                                <option value="XI-4">XI-4</option>
                                <option value="XI-5">XI-5</option>
                                <option value="XII-1">XII-1</option>
                                <option value="XII-2">XII-2</option>
                                <option value="XII-3">XII-3</option>
                                <option value="XII-4">XII-4</option>
                                <option value="XII-5">XII-5</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Mata Pelajaran</label>
                            <select class="form-select" name="mata_pelajaran" id="mataPelajaranSelect" required>
                                <option value="">Pilih Mata Pelajaran</option>
                                <option value="Matematika">Matematika</option>
                                <option value="Fisika">Fisika</option>
                                <option value="Kimia">Kimia</option>
                                <option value="Biologi">Biologi</option>
                                <option value="Bahasa Indonesia">Bahasa Indonesia</option>
                                <option value="Bahasa Inggris">Bahasa Inggris</option>
                                <option value="Sejarah">Sejarah</option>
                                <option value="Geografi">Geografi</option>
                                <option value="Ekonomi">Ekonomi</option>
                                <option value="Sosiologi">Sosiologi</option>
                                <option value="Akidah Akhlak">Akidah Akhlak</option>
                                <option value="Alquran Hadits">Alquran Hadits</option>
                                <option value="Fiqih">Fiqih</option>
                                <option value="Bahasa Arab">Bahasa Arab</option>
                                <option value="Sejarah Kebudayaan Islam">Sejarah Kebudayaan Islam</option>
                                <option value="Matematika Lanjut">Matematika Lanjut</option>
                                <option value="PJOK">PJOK</option>
                                <option value="Prakarya">Prakarya</option>
                                <option value="Seni Budaya">Seni Budaya</option>
                                <option value="Bimbingan Konseling">Bimbingan Konseling</option>
                                <option value="PKn">Pendidikan Kewarganegaraan</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-secondary">Simpan Jadwal</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function loadKehadiran() {
    document.getElementById('dynamic-content').innerHTML = `
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-clock"></i> Kehadiran Guru Hari Ini</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Nama Guru</th>
                                <th>NIP</th>
                                <th>Kelas</th>
                                <th>Mata Pelajaran</th>
                                <th>Jam Masuk</th>
                                <th>Jam Keluar</th>
                                <th>Status</th>
                                <th>Keterangan</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="6" class="text-center">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
    
    // Fetch data kehadiran via AJAX
    fetch('/api/kehadiran-hari-ini')
        .then(response => response.json())
        .then(data => {
            // Update table with real data
            console.log('Data kehadiran:', data);
        });
}

function loadDaftarGuru() {
    document.getElementById('dynamic-content').innerHTML = `
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-users"></i> Daftar Guru</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="guruTable">
                        <thead>
                            <tr>
                                <th>Nama</th>
                                <th>NIP</th>
                                <th>Mata Pelajaran</th>
                                <th>Email</th>
                                <th>QR Code</th>
                                <th>Tanggal Dibuat</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="7" class="text-center">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
    
    // Fetch data guru
    fetch('/api/daftar-guru')
        .then(response => response.json())
        .then(data => {
            const tbody = document.querySelector('#guruTable tbody');
            if (data.success && data.data.length > 0) {
                tbody.innerHTML = '';
                data.data.forEach(guru => {
                    const qrCodeImg = guru.qr_code ? 
                        `<img src="data:image/png;base64,${guru.qr_code}" width="50" height="50" alt="QR Code">` : 
                        '<span class="text-muted">Belum ada</span>';
                    
                    tbody.innerHTML += `
                        <tr>
                            <td>${guru.nama}</td>
                            <td>${guru.nip}</td>
                            <td>${guru.mata_pelajaran}</td>
                            <td>${guru.email}</td>
                            <td>${qrCodeImg}</td>
                            <td>${guru.created_at}</td>
                            <td>
                                <button class="btn btn-sm btn-warning" onclick="editPassword(${guru.id}, '${guru.nama}')" title="Edit Password">
                                    <i class="fas fa-key"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="hapusGuru(${guru.id}, '${guru.nama}')" title="Hapus Guru">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Belum ada data guru</td></tr>';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.querySelector('#guruTable tbody').innerHTML = 
                '<tr><td colspan="7" class="text-center text-danger">Error loading data</td></tr>';
        });
}

function loadJurnal() {
    document.getElementById('dynamic-content').innerHTML = `
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-book"></i> Jurnal Pembelajaran Hari Ini</h5>
                <button class="btn btn-success btn-sm" onclick="printJurnal()">
                    <i class="fas fa-print"></i> Print Jurnal
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="jurnalTable">
                        <thead>
                            <tr>
                                <th>Waktu</th>
                                <th>Guru</th>
                                <th>Kelas</th>
                                <th>Mata Pelajaran</th>
                                <th>Materi</th>
                                <th>Metode</th>
                                <th>Kehadiran</th>
                                <th>Catatan</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="8" class="text-center">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
    
    // Fetch data jurnal
    fetch('/api/monitoring-jurnal')
        .then(response => response.json())
        .then(data => {
            const tbody = document.querySelector('#jurnalTable tbody');
            if (data.success && data.data.length > 0) {
                tbody.innerHTML = '';
                data.data.forEach(jurnal => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${jurnal.waktu_input}</td>
                            <td>
                                <strong>${jurnal.guru_nama}</strong><br>
                                <small class="text-muted">${jurnal.guru_nip}</small>
                            </td>
                            <td>${jurnal.kelas}</td>
                            <td>${jurnal.mata_pelajaran}</td>
                            <td>${jurnal.materi}</td>
                            <td>${jurnal.metode_pembelajaran || '-'}</td>
                            <td>
                                <span class="badge bg-success">${jurnal.siswa_hadir} Hadir</span>
                                ${jurnal.siswa_tidak_hadir > 0 ? `<span class="badge bg-warning">${jurnal.siswa_tidak_hadir} Tidak Hadir</span>` : ''}
                            </td>
                            <td>${jurnal.catatan || '-'}</td>
                        </tr>
                    `;
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Belum ada jurnal hari ini</td></tr>';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.querySelector('#jurnalTable tbody').innerHTML = 
                '<tr><td colspan="8" class="text-center text-danger">Error loading data</td></tr>';
        });
}

function loadTugas() {
    document.getElementById('dynamic-content').innerHTML = `
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-tasks"></i> Monitoring Tugas Aktif</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="tugasTable">
                        <thead>
                            <tr>
                                <th>Guru</th>
                                <th>Judul Tugas</th>
                                <th>Kelas</th>
                                <th>Mata Pelajaran</th>
                                <th>Diberikan</th>
                                <th>Deadline</th>
                                <th>Status</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="8" class="text-center">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
    
    // Fetch data tugas
    fetch('/api/monitoring-tugas')
        .then(response => response.json())
        .then(data => {
            const tbody = document.querySelector('#tugasTable tbody');
            if (data.success && data.data.length > 0) {
                tbody.innerHTML = '';
                data.data.forEach(tugas => {
                    let statusBadge = '';
                    if (tugas.status_deadline === 'overdue') {
                        statusBadge = `<span class="badge bg-danger">Terlambat ${Math.abs(tugas.sisa_hari)} hari</span>`;
                    } else if (tugas.status_deadline === 'urgent') {
                        statusBadge = `<span class="badge bg-warning">${tugas.sisa_hari} hari lagi</span>`;
                    } else {
                        statusBadge = `<span class="badge bg-success">${tugas.sisa_hari} hari lagi</span>`;
                    }
                    
                    tbody.innerHTML += `
                        <tr>
                            <td>
                                <strong>${tugas.guru_nama}</strong><br>
                                <small class="text-muted">${tugas.guru_nip}</small>
                            </td>
                            <td>
                                <strong>${tugas.judul}</strong><br>
                                <small class="text-muted">${tugas.deskripsi.substring(0, 50)}...</small>
                            </td>
                            <td>${tugas.kelas}</td>
                            <td>${tugas.mata_pelajaran}</td>
                            <td>${tugas.tanggal_diberikan}</td>
                            <td>${tugas.deadline}</td>
                            <td>${statusBadge}</td>
                            <td>
                                <button class="btn btn-sm btn-info" onclick="viewTugas(${tugas.id})">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Belum ada tugas aktif</td></tr>';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.querySelector('#tugasTable tbody').innerHTML = 
                '<tr><td colspan="8" class="text-center text-danger">Error loading data</td></tr>';
        });
}

function viewTugas(tugasId) {
    // Implementasi view detail tugas
    alert('Fitur view detail tugas akan segera tersedia');
}

function loadJadwal() {
    document.getElementById('dynamic-content').innerHTML = `
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-calendar-alt"></i> Jadwal Mengajar</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="jadwalTable">
                        <thead>
                            <tr>
                                <th>Hari</th>
                                <th>Jam</th>
                                <th>Guru</th>
                                <th>Kelas</th>
                                <th>Mata Pelajaran</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="6" class="text-center">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
    
    // Fetch data jadwal
    fetch('/api/jadwal-mengajar')
        .then(response => response.json())
        .then(data => {
            const tbody = document.querySelector('#jadwalTable tbody');
            if (data.success && data.data.length > 0) {
                tbody.innerHTML = '';
                
                // Group by hari
                const groupedData = {};
                data.data.forEach(jadwal => {
                    if (!groupedData[jadwal.hari]) {
                        groupedData[jadwal.hari] = [];
                    }
                    groupedData[jadwal.hari].push(jadwal);
                });
                
                // Urutan hari
                const hariOrder = ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
                
                hariOrder.forEach(hari => {
                    if (groupedData[hari]) {
                        groupedData[hari].forEach((jadwal, index) => {
                            tbody.innerHTML += `
                                <tr>
                                    ${index === 0 ? `<td rowspan="${groupedData[hari].length}" class="align-middle"><strong>${hari}</strong></td>` : ''}
                                    <td>${jadwal.jam_mulai} - ${jadwal.jam_selesai}</td>
                                    <td>
                                        <strong>${jadwal.guru_nama}</strong><br>
                                        <small class="text-muted">${jadwal.guru_nip}</small>
                                    </td>
                                    <td><span class="badge bg-primary">${jadwal.kelas}</span></td>
                                    <td>${jadwal.mata_pelajaran}</td>
                                    <td>
                                        <button class="btn btn-sm btn-danger" onclick="hapusJadwal(${jadwal.id})">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            `;
                        });
                    }
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Belum ada jadwal mengajar</td></tr>';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.querySelector('#jadwalTable tbody').innerHTML = 
                '<tr><td colspan="6" class="text-center text-danger">Error loading data</td></tr>';
        });
}

function hapusJadwal(jadwalId) {
    if (confirm('Yakin ingin menghapus jadwal ini?')) {
        fetch(`/api/hapus-jadwal/${jadwalId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Jadwal berhasil dihapus!');
                loadJadwal(); // Refresh table
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            alert('Terjadi kesalahan: ' + error);
        });
    }
}

// Load guru list when modal opens
document.getElementById('jadwalModal').addEventListener('show.bs.modal', function () {
    fetch('/api/daftar-guru')
        .then(response => response.json())
        .then(data => {
            const guruSelect = document.getElementById('guruSelect');
            guruSelect.innerHTML = '<option value="">Pilih Guru</option>';
            
            if (data.success && data.data.length > 0) {
                data.data.forEach(guru => {
                    guruSelect.innerHTML += `<option value="${guru.id}">${guru.nama} - ${guru.mata_pelajaran}</option>`;
                });
            }
        });
});

// Auto-fill mata pelajaran based on selected guru
document.getElementById('guruSelect').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    if (selectedOption.value) {
        const mataPelajaran = selectedOption.text.split(' - ')[1];
        const mataPelajaranSelect = document.getElementById('mataPelajaranSelect');
        mataPelajaranSelect.value = mataPelajaran;
    }
});

// Handle form submission
document.getElementById('guruForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = Object.fromEntries(formData);
    
    fetch('/api/tambah-guru', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Guru berhasil ditambahkan!');
            bootstrap.Modal.getInstance(document.getElementById('guruModal')).hide();
            this.reset();
            // Refresh daftar guru jika sedang ditampilkan
            if (document.getElementById('guruTable')) {
                loadDaftarGuru();
            }
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        alert('Terjadi kesalahan: ' + error);
    });
});

// Handle jadwal form submission
document.getElementById('jadwalForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = Object.fromEntries(formData);
    
    fetch('/api/tambah-jadwal', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Jadwal berhasil ditambahkan!');
            bootstrap.Modal.getInstance(document.getElementById('jadwalModal')).hide();
            this.reset();
            // Refresh jadwal jika sedang ditampilkan
            if (document.getElementById('jadwalTable')) {
                loadJadwal();
            }
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        alert('Terjadi kesalahan: ' + error);
    });
});

// Function untuk hapus guru
function hapusGuru(guruId, namaGuru) {
    if (confirm(`Yakin ingin menghapus guru ${namaGuru}? Semua data terkait akan ikut terhapus.`)) {
        fetch(`/api/hapus-guru/${guruId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Guru berhasil dihapus!');
                loadDaftarGuru(); // Refresh table
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            alert('Terjadi kesalahan: ' + error);
        });
    }
}

// Function untuk edit password guru
function editPassword(guruId, namaGuru) {
    const newPassword = prompt(`Masukkan password baru untuk ${namaGuru}:`);
    if (newPassword && newPassword.length >= 6) {
        fetch('/api/edit-password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                guru_id: guruId,
                new_password: newPassword
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Password berhasil diubah!');
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            alert('Terjadi kesalahan: ' + error);
        });
    } else if (newPassword !== null) {
        alert('Password minimal 6 karakter!');
    }
}

// Function untuk print jurnal
function printJurnal() {
    const tanggalMulai = prompt('Tanggal mulai (YYYY-MM-DD):');
    const tanggalSelesai = prompt('Tanggal selesai (YYYY-MM-DD):');
    
    if (tanggalMulai && tanggalSelesai) {
        const params = new URLSearchParams({
            tanggal_mulai: tanggalMulai,
            tanggal_selesai: tanggalSelesai
        });
        
        fetch(`/api/print-jurnal?${params}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.data.length > 0) {
                    // Create print window
                    const printWindow = window.open('', '_blank');
                    let printContent = `
                        <html>
                        <head>
                            <title>Laporan Jurnal Pembelajaran</title>
                            <style>
                                body { font-family: Arial, sans-serif; margin: 20px; }
                                h1 { text-align: center; color: #333; }
                                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                                th { background-color: #f2f2f2; font-weight: bold; }
                                .text-center { text-align: center; }
                                @media print { body { margin: 0; } }
                            </style>
                        </head>
                        <body>
                            <h1>LAPORAN JURNAL PEMBELAJARAN</h1>
                            <h2>MAN Insan Cendekia Kendari</h2>
                            <p><strong>Periode:</strong> ${tanggalMulai} s/d ${tanggalSelesai}</p>
                            <table>
                                <thead>
                                    <tr>
                                        <th>No</th>
                                        <th>Tanggal</th>
                                        <th>Guru</th>
                                        <th>Kelas</th>
                                        <th>Mata Pelajaran</th>
                                        <th>Materi</th>
                                        <th>Metode</th>
                                        <th>Kehadiran</th>
                                        <th>Catatan</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    data.data.forEach((jurnal, index) => {
                        printContent += `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${jurnal.tanggal}</td>
                                <td>${jurnal.guru_nama}<br><small>${jurnal.guru_nip}</small></td>
                                <td>${jurnal.kelas}</td>
                                <td>${jurnal.mata_pelajaran}</td>
                                <td>${jurnal.materi}</td>
                                <td>${jurnal.metode_pembelajaran || '-'}</td>
                                <td>H: ${jurnal.siswa_hadir}, TH: ${jurnal.siswa_tidak_hadir}</td>
                                <td>${jurnal.catatan || '-'}</td>
                            </tr>
                        `;
                    });
                    
                    printContent += `
                                </tbody>
                            </table>
                            <p style="margin-top: 30px;"><strong>Total Jurnal:</strong> ${data.data.length} entries</p>
                            <p style="margin-top: 50px; text-align: right;">
                                Kendari, ${new Date().toLocaleDateString('id-ID')}<br><br><br>
                                Tim Akademik MAN IC Kendari
                            </p>
                        </body>
                        </html>
                    `;
                    
                    printWindow.document.write(printContent);
                    printWindow.document.close();
                    printWindow.print();
                } else {
                    alert('Tidak ada data jurnal untuk periode tersebut');
                }
            })
            .catch(error => {
                alert('Error: ' + error);
            });
    }
}
</script>
{% endblock %}
